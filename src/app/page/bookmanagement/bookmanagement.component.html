<div class="card mt-3">
  <div class="card-header bg-white py-3">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Book Management</h5>
      <button class="btn btn-primary" (click)="openAddBookModal()">
        <i class="fas fa-plus me-1"></i> Add New Book
      </button>
    </div>
  </div>
  <div class="container">
    <ngx-datatable
      class="material"
      [rows]="bookService.data.items"
      [count]="bookService.data.totalCount"
      [columnMode]="'force'"
      [externalPaging]="true"
      [limit]="bookService.filter.maxResultCount"
      [footerHeight]="50"
      [headerHeight]="50"
      [rowHeight]="60"
      (page)="onPageChange($event)"
      [trackByProp]="'id'"
      [externalSorting]="false"
    >
      <!-- Book Name column -->
      <ngx-datatable-column name="Book Name" prop="name" [sortable]="true">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <strong>{{ value }}</strong>
        </ng-template>
      </ngx-datatable-column>

      <!-- Type column -->
      <ngx-datatable-column name="Type" prop="type" [sortable]="true" width="150">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <span class="badge bg-info">{{ getBookTypeText(value) }}</span>
        </ng-template>
      </ngx-datatable-column>

      <!-- Price column -->
      <ngx-datatable-column name="Price" prop="price" [sortable]="true" width="150">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <span class="text-success fw-bold">{{ value | currency: 'VND' }}</span>
        </ng-template>
      </ngx-datatable-column>

      <!-- Publish Date column -->
      <ngx-datatable-column name="Publish Date" prop="publishDate" [sortable]="true" width="150">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          {{ value | date: 'dd/MM/yyyy' }}
        </ng-template>
      </ngx-datatable-column>

      <!-- Actions column -->
      <ngx-datatable-column name="Actions" [sortable]="false" [canAutoResize]="false" width="120">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" (click)="editBook(row)" title="Edit Book">
              <i class="bi bi-pencil"></i>
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="bookService.delete(row)"
              title="Delete Book"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </ng-template>
      </ngx-datatable-column>
    </ngx-datatable>
  </div>
</div>

<!-- Add Book Modal -->
<ng-template #addBookModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add New Book</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="bookForm">
      <div class="mb-3">
        <label for="name" class="form-label">Book Name</label>
        <input type="text" class="form-control" id="name" formControlName="name" required />
      </div>
      <div class="mb-3">
        <label for="type" class="form-label">Book Type</label>
        <ng-select
          id="type"
          name="type"
          formControlName="type"
          [items]="bookTypes"
          bindLabel="label"
          bindValue="value"
          placeholder="Select a book type"
          [clearable]="false"
          required
        ></ng-select>
      </div>
      <div class="mb-3">
        <label for="price" class="form-label">Price</label>
        <input
          type="number"
          class="form-control"
          id="price"
          formControlName="price"
          required
          min="0"
          appCurrencyFormat
        />
      </div>
      <div class="mb-3">
        <label for="publishDate" class="form-label">Publish Date</label>
        <input type="date" class="form-control" id="publishDate" formControlName="publishDate" />
        <div
          *ngIf="
            bookForm.get('publishDate')?.hasError('notToday') &&
            bookForm.get('publishDate')?.touched
          "
          class="text-danger mt-1"
        >
          Publish date cannot be today. Please select a different date.
        </div>
      </div>
      <div class="mb-3">
        <label for="authorIds" class="form-label">Authors</label>
        <ng-select
          id="authorIds"
          name="authorIds"
          formControlName="authorIds"
          [items]="bookService.authordata.items"
          bindLabel="name"
          bindValue="id"
          [multiple]="true"
          [closeOnSelect]="false"
          placeholder="Select authors"
        ></ng-select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="saveBook(modal)"
      [disabled]="!bookForm.valid"
    >
      Save
    </button>
  </div>
</ng-template>
