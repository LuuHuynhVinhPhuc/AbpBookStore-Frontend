<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-7">
      <h4 class="fw-bold mb-3">Checkout</h4>
      <form
        *ngIf="!orderConfirmed"
        [formGroup]="checkoutForm"
        (ngSubmit)="confirmOrder()"
        autocomplete="off"
      >
        <!-- Thông tin giao hàng -->
        <div class="card mb-3 border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Shipping Information</h6>
            <div class="mb-2">
              <label class="form-label">Full Name</label>
              <input
                class="form-control"
                formControlName="fullName"
                [ngClass]="{
                  'is-invalid':
                    formControls['fullName'].touched && formControls['fullName'].invalid,
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="formControls['fullName'].touched && formControls['fullName'].invalid"
              >
                <span *ngIf="formControls['fullName'].errors?.['required']"
                  >Full name is required</span
                >
                <span *ngIf="formControls['fullName'].errors?.['minlength']"
                  >Full name must be at least 2 characters</span
                >
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Address</label>
              <input
                class="form-control"
                formControlName="address"
                [ngClass]="{
                  'is-invalid': formControls['address'].touched && formControls['address'].invalid,
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="formControls['address'].touched && formControls['address'].invalid"
              >
                <span *ngIf="formControls['address'].errors?.['required']"
                  >Address is required</span
                >
                <span *ngIf="formControls['address'].errors?.['minlength']"
                  >Address must be at least 5 characters</span
                >
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Phone</label>
              <input
                class="form-control"
                formControlName="phone"
                [ngClass]="{
                  'is-invalid': formControls['phone'].touched && formControls['phone'].invalid,
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="formControls['phone'].touched && formControls['phone'].invalid"
              >
                <span *ngIf="formControls['phone'].errors?.['required']"
                  >Phone number is required</span
                >
                <span *ngIf="formControls['phone'].errors?.['pattern']"
                  >Please enter a valid phone number (10-11 digits)</span
                >
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Email</label>
              <input
                class="form-control"
                formControlName="email"
                type="email"
                [ngClass]="{
                  'is-invalid': formControls['email'].touched && formControls['email'].invalid,
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="formControls['email'].touched && formControls['email'].invalid"
              >
                <span *ngIf="formControls['email'].errors?.['required']">Email is required</span>
                <span *ngIf="formControls['email'].errors?.['email']"
                  >Please enter a valid email address</span
                >
              </div>
            </div>
          </div>
        </div>
        <!-- Phương thức thanh toán -->
        <div class="card mb-3 border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Payment Method</h6>
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                formControlName="paymentMethod"
                value="Cash"
                id="cash"
              />
              <label class="form-check-label" for="cash">Cash on Delivery</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                formControlName="paymentMethod"
                value="Card"
                id="card"
              />
              <label class="form-check-label" for="card">Credit/Debit Card</label>
            </div>
          </div>
        </div>
        <!-- Thông tin đơn hàng -->
        <div class="card mb-3 border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Order Summary</h6>
            <div *ngIf="selectedItems.length === 0" class="text-center py-3">
              <p class="text-muted mb-0">No items selected</p>
            </div>
            <div *ngFor="let item of selectedItems" class="d-flex align-items-center mb-2">
              <img
                [src]="item.book?.image"
                [alt]="item.book?.name"
                class="rounded me-2"
                style="width: 40px; height: 40px; object-fit: cover"
              />
              <div class="flex-grow-1">
                <div class="small fw-semibold">{{ item.book?.name }}</div>
                <div class="text-muted small">
                  <ng-container *ngFor="let author of item.book?.authors; let last = last">
                    {{ author.name }}<span *ngIf="!last">, </span>
                  </ng-container>
                </div>
                <div class="text-muted small">x{{ item.quantity }}</div>
              </div>
              <div class="fw-bold text-primary">
                {{ item.book?.price * item.quantity | currency: 'VND' }}
              </div>
            </div>
            <hr />
            <div class="d-flex justify-content-between mb-1 small">
              <span>Subtotal</span>
              <span>{{ subtotal | currency: 'VND' }}</span>
            </div>
            <div class="d-flex justify-content-between mb-1 small">
              <span>Shipping</span>
              <span>{{ shipping === 0 ? 'Free' : (shipping | currency: 'VND') }}</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <strong>Total</strong>
              <strong>{{ total | currency: 'VND' }}</strong>
            </div>
          </div>
        </div>
        <div class="d-grid">
          <button
            class="btn btn-primary btn-lg rounded-pill"
            type="submit"
            [disabled]="checkoutForm.invalid || isSubmitting"
            (click)="confirmOrder()"
          >
            <span *ngIf="!isSubmitting">Confirm Order</span>
            <span *ngIf="isSubmitting">
              <span
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></span>
              Processing...
            </span>
          </button>
        </div>
      </form>
      <!-- Thông báo xác nhận -->
      <div *ngIf="orderConfirmed" class="text-center py-5">
        <i class="fas fa-check-circle fa-3x text-success mb-3"> </i>
        <h4 class="mb-3">Thank you for your order!</h4>
        <p class="text-muted">Your order has been placed successfully. We will contact you soon.</p>
        <button routerLink="/dashboard" class="btn btn-outline-primary mt-3" title="Back to Home">
          <i class="fas fa-arrow-left me-1" aria-hidden="true"></i> Back to Home
        </button>
      </div>
    </div>
  </div>
</div>
